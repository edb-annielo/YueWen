window.templateLoader={templates:{},load:function(views,callback){var deferreds=[];var self=this;$.each(views,function(index,view){deferreds.push($.ajax({url:"tmpl/"+view+".html",success:function(data){if(window[view])window[view].prototype.template=_.template(data);self.templates[view]=data},dataType:"html",cache:false}))});$.when.apply(null,deferreds).done(callback)}};
window.writeFile=function(_opt){if(!appFunc.isApp())return;var option=$.extend({folder:null,filename:null,content:"",success:null,error:null,progress:null},_opt);if(option.filename==null)return;function errorCallback(event){if(option.error)option.error(event)}function writeFileToDir(dirEntry){dirEntry.getFile(option.filename,{create:true,exclusive:false},function(file){file.createWriter(function(writer){writer.onwrite=function(event){if(option.success)option.success(event)};writer.onerror=errorCallback;
writer.write(option.content)},errorCallback)},errorCallback)}window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(fileSystem){fileSystem.root.getDirectory("yuewen",{create:true,exclusive:false},function(dirEntry){if(siteInfo.isAppIOS())try{function onSetMetadataSuccess(){}function onSetMetadataFail(){alert("There was an error in setting the metadata")}dirEntry.setMetadata(onSetMetadataSuccess,onSetMetadataFail,{"com.apple.MobileBackup":1})}catch(err){}if(option.folder!=null)dirEntry.getDirectory(option.folder,
{create:true,exclusive:false},writeFileToDir,errorCallback);else writeFileToDir(dirEntry)},errorCallback)},errorCallback)};
window.readFile=function(_opt){if(!appFunc.isApp())return;var option=$.extend({folder:null,filename:null,success:null,error:null,progress:null},_opt);if(option.filename==null)return;function errorCallback(event){if(option.error)option.error(event)}function readFileFromDir(dirEntry){dirEntry.getFile(option.filename,{create:false,exclusive:false},function(fileEntry){fileEntry.file(function(file){var reader=new FileReader;reader.onloadend=function(event){var data=Convert.StringToJson(event.target.result);
if(option.success)option.success(data,file)};reader.onerror=errorCallback;reader.readAsText(file)},errorCallback)},errorCallback)}window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(fileSystem){fileSystem.root.getDirectory("yuewen",{create:true,exclusive:false},function(dirEntry){if(siteInfo.isAppIOS())try{function onSetMetadataSuccess(){}function onSetMetadataFail(){alert("There was an error in setting the metadata")}dirEntry.setMetadata(onSetMetadataSuccess,onSetMetadataFail,{"com.apple.MobileBackup":1})}catch(err){}if(option.folder!=
null)dirEntry.getDirectory(option.folder,{create:false,exclusive:false},readFileFromDir,errorCallback);else readFileFromDir(dirEntry)},errorCallback)},errorCallback)};function loadData(){var _FIELDS=FIELDS||{};if(_.isEmpty(_FIELDS))readFile({folder:"data",filename:"data.txt",success:function(data){var _FIELDS=FIELDS||{};if(_.isEmpty(_FIELDS))FIELDS=data.fields}})}
function LoadFromOffline(_opt){if(!appFunc.isApp())return;try{var db=appFunc.db;var option=$.extend({table:null,queryData:null,id:null,success:null,error:null,progress:null},_opt);switch(option.table){case "passage":if(option.id){var filename=option.id+".txt";window.readFile({folder:"passage",filename:filename,success:option.success,error:option.error})}else{var $pageSize=50;var $pageNum=1;var $rowCount=0;var $mode=null;var $searchText="";var $searchStr={};var sql_where="";var sql_where_param=[];
var sql_order="";var orderbyFld="title";var orderbyFld2="title";var orderbyDir="ASC";var queryData=option.queryData;if(queryData!=null){try{if(!empty2(queryData["page"]))$pageNum=parseInt(queryData["page"],10)}catch(err1){}try{if(!empty2(queryData["mode"]))if(queryData["mode"]=="translation"){$mode=queryData["mode"];sql_where+=(empty2(sql_where)?"WHERE":"AND")+" (translated=1) "}}catch(err1){}try{if(!empty2(queryData["search"])){$searchText=queryData["search"];$searchStr={"any":$searchText};var $searchText2=
"%"+$searchText+"%";var $wildcard="?";sql_where_param=[$searchText2,$searchText2,$searchText2,$searchText2,$searchText2,$searchText2,$searchText2,$searchText2];sql_where+=(empty2(sql_where)?"WHERE":"AND")+" ( "+"title LIKE "+$wildcard+"  OR "+"author LIKE "+$wildcard+" OR "+"firstLine LIKE "+$wildcard+" OR "+"tags  LIKE "+$wildcard+" OR "+"stylisticText  LIKE "+$wildcard+" OR "+"levelText LIKE "+$wildcard+" OR "+"dynastyText LIKE "+$wildcard+" OR "+"categoryText LIKE "+$wildcard+" "+") "}}catch(err1){}try{if(!empty2(queryData["fld"]))if($.inArray(queryData["fld"],
["title","author","lastUpdate"])>=0)orderbyFld=orderbyFld2=queryData["fld"];else if($.inArray(queryData["fld"],["stylistic"])>=0){orderbyFld=queryData["fld"];orderbyFld2="stylisticText"}if(!empty2(queryData["dir"]))if($.inArray(queryData["dir"],["ASC","DESC"])>=0)orderbyDir=queryData["dir"]}catch(err1){}}sql_order=" ORDER BY "+orderbyFld2+" "+orderbyDir;function loadPassageList(tx,rs){var pagingData={};function paging($rowCount,$pageSize,$currPage){if($currPage==null)$currPage=1;var $totalPage=Math.ceil($rowCount/
$pageSize);if($currPage>$totalPage)$currPage=$totalPage;if($currPage<=0)$currPage=1;pagingData={rowCount:$rowCount,pageSize:$pageSize,pageNum:$currPage,maxpage:$totalPage,startIndex:($currPage-1)*$pageSize,endIndex:Math.min($rowCount,$currPage*$pageSize)}}paging(rs.rows.length,$pageSize,$pageNum);$pageSize=pagingData.pageSize;$pageNum=pagingData.pageNum;$rowCount=pagingData.rowCount;$startIndex=pagingData.startIndex;$endIndex=pagingData.endIndex;var passages=[];for(var $count=$startIndex;$count<$endIndex;$count++){var row=
rs.rows.item($count);passages.push(row)}if(option.success)option.success({passages:passages,paging:pagingData,searchData:{searchText:$searchText,searchStr:$searchStr},orderbyFld:orderbyFld,orderbyDir:orderbyDir,mode:$mode,success:true,error:null})}function populatePassageList(tx){tx.executeSql("SELECT * FROM passage "+sql_where+" "+sql_order,sql_where_param,loadPassageList,function(tx,sqlerr){option.error(err)})}db.transaction(populatePassageList,option.error)}break}}catch(err){console.log(err)}}
function downloadPassagesOffline(){if(!siteInfo.isApp())return;$(".divDownload .btnDownload").attr("disabled","");var error=false;function errorCB(errorType){if(!error)switch(errorType){case "ajax":appFunc.alert("下載失敗，請稍後再次嘗試。");break;case "writeFile":appFunc.alert("儲存篇章失敗，請稍後再次嘗試。");break;default:appFunc.alert("發生錯誤，請稍後再次嘗試。");break}error=true;$(".divDownload .btnDownload").removeAttr("disabled")}$.ajax({url:rootURL+"/data.php",success:function(data,textStatus,xhr){if(data.success==true){FIELDS=
data.fields;writeFile({folder:"data",filename:"data.txt",content:xhr.responseText})}else errorCB()},error:errorCB,dataType:"json",async:false,cache:false});if(error==true){appFunc.alert("沒有網路連線。\n請確定流動裝置成功連上網路(如：3g、4g或WiFi)後再次嘗試。");return}else;$(".divDownload .divProgress").show();$(".divDownload .divProgress .spanProgress").text("準備中");$(".divDownload .progress .bar").css("width","0%");$.ajax({type:"GET",url:rootURL+"/allpassages.php",success:function(data,textStatus,xhr){if(data.success==true){var deferreds=
[];var passageCount=0;var totalPassage=data.passages.length;$(".divDownload .divProgress .spanProgress").text(passageCount+"/"+totalPassage);$(".divDownload .progress .bar").css("width",Math.round(passageCount*100/totalPassage)+"%");$.each(data.passages,function(index,passage){var filename=passage.id+".txt";deferreds.push($.ajax({type:"GET",url:rootURL+"/reading.php?id="+passage.id,success:function(data,textStatus,xhr){if(data.success==true)window.writeFile({folder:"passage",filename:filename,content:xhr.responseText,
error:function(){errorCB("writeFile")},success:function(){passageCount++;$(".divDownload .btnDownload").attr("disabled","");$(".divDownload .divProgress .spanProgress").text(passageCount+"/"+totalPassage);$(".divDownload .divProgress").show();$(".divDownload .progress .bar").css("width",Math.round(passageCount*100/totalPassage)+"%")}})},error:function(xhr,textStatus,errorThrown){errorCB("ajax")},dataType:"json",async:true}))});$.when.apply($,deferreds).done(function(){writeFile({folder:"data",filename:"allpassages.txt",
content:xhr.responseText,success:function(){appFunc.loadPassagesIntoDB(data,errorCB,function(){$(".divDownload .divProgress").hide();appFunc.set({lastOfflineUpdate:new Date,offlineReady:true});appRouter.reloadPage();appFunc.alert("下載完成！")})}})})}},error:function(xhr,textStatus,errorThrown){},dataType:"json",async:false})};$(document).ajaxError(function(event,xhr){var status=200;try{status=xhr.status}catch(err){}if(status==401){try{appRouter.siteFooter.show({action:"error",xhr:xhr})}catch(err){}appRouter.showHome()}});String.prototype.repeat=function(count){if(count<1)return"";var result="",pattern=this.valueOf();while(count>0){if(count&1)result+=pattern;count>>=1,pattern+=pattern}return result};if(typeof Number.prototype.toRad==="undefined")Number.prototype.toRad=function(){return this*Math.PI/180};
Convert={ToHalfWidthEng:function(val){if(val==null)return null;var reFull=/([\uFF10-\uFF19\uFF21-\uFF34\uFF41-\uFF5A])/g;if(reFull.test(val))return val.replace(reFull,function(s,key){try{var fwChar=s.charCodeAt(0);var hwChar=fwChar-65296+48;return String.fromCharCode(hwChar)}catch(err){}return s});else return val},ToHms:function(timestamp){var result_timestamp=timestamp;return{d:Math.floor(result_timestamp/864E5),H:Math.floor(result_timestamp/36E5),h:Math.floor(result_timestamp/36E5)%24,m:Math.floor(result_timestamp/
6E4)%60,s:Math.floor(result_timestamp/1E3)%60,ms:result_timestamp%1E3}},ToHhmmss:function(timestamp){var result_hms=Convert.ToHms(timestamp);return $.extend({days:Convert.IntToString(result_hms.days,1),HH:Convert.IntToString(result_hms.H,2),hh:Convert.IntToString(result_hms.h,2),mm:Convert.IntToString(result_hms.m,2),ss:Convert.IntToString(result_hms.s,2),ms:result_hms.ms+""},result_hms)},IntToString:function(val,digits){var str=val+"";return"0".repeat(digits-str.length)+str},ToBoolean:function(val){if(_.isUndefined(val)||
_.isNull(val))return false;else if(_.isBoolean(val))return val;else if(_.isNumber(val))return val>0;else if(_.isString(val))try{switch(val.toLowerCase()){case "true":case "yes":case "1":return true;case "false":case "no":case "0":case "":return false}return parseInt(val,10)>0}catch(err){}return false},ToInt:function(val){try{return parseInt(val,10)}catch(err){return 0}},ToFloat:function(val){try{return parseFloat(val)}catch(err){return 0}},ToDateTime:function(val,fromDB){if(_.isUndefined(val)||_.isNull(val))return null;
else if(_.isDate(val))return val;else if(_.isNumber(val))return new Date(val);else if(_.isString(val)){if(fromDB===true){var momentObj=moment.unix(parseInt(val,10));if(momentObj.isValid())return momentObj.toDate();momentObj=moment(val,["YYYY-MM-DD HH:mm:ss","YYYY-MM-DD"]);if(momentObj.isValid())return momentObj.toDate()}return new Date(val)}return null},JsonToString:function(obj){return JSON.stringify(obj,null,2)},StringToJson:function(str){return $.parseJSON(str)},BBCodetoHtml:function(bbcode){if(bbcode==
null)return"";var fix_search=[{search:/\s*\[list(=([0-9]+))?\]\s*/ig,fix:"[list$1]"},{search:/\s*\[\*\]\s*/ig,fix:"[*]"},{search:/\s*\[\/list\]\s*/ig,fix:"[/list]"}];for(var i=0;i<fix_search.length;i++)bbcode=bbcode.replace(fix_search[i].search,fix_search[i].fix);var htmlConvert_search=[{search:/</ig,fix:"&lt;"},{search:/>/ig,fix:"&gt;"},{search:/\n/ig,fix:"<br />"}];for(var i=0;i<htmlConvert_search.length;i++)bbcode=bbcode.replace(htmlConvert_search[i].search,htmlConvert_search[i].fix);var bbTag_search=
[{search:/\[b\](.*?)\[\/b\]/ig,fix:"<strong>$1</strong>"},{search:/\[i\](.*?)\[\/i\]/ig,fix:"<em>$1</em>"},{search:/\[u\](.*?)\[\/u\]/ig,fix:'<span style="text-decoration: underline;">$1</span>'},{search:/\[s\](.*?)\[\/s\]/ig,fix:'<span style="text-decoration: line-through;">$1</span>'},{search:/\[url=([^\s]+)\](.*?)\[\/url\]/ig,fix:'<a href="$1" target="_blank">$2</a>'},{search:/\[url\]([^\s]+)\[\/url\]/ig,fix:'<a href="$1" class="url" target="_blank">$1</a>'},{search:/\[img\](.*?)\[\/img\]/ig,fix:'<img src="$1" />'},
{search:/\[\*\]/ig,fix:"<li>"},{search:/\[li\](.*?)\[\/li\]/ig,fix:"<li>$1</li>"},{search:/\[list=([0-9]+)\](.*?)\[\/list\]/ig,fix:'<ol start="$1">$2</ol>'},{search:/\[list\](.*?)\[\/list\]/ig,fix:"<ul>$1</ul>"}];for(var i=0;i<bbTag_search.length;i++)bbcode=bbcode.replace(bbTag_search[i].search,bbTag_search[i].fix);return bbcode},ToQuery:function(data,arg){var query=$.extend({},data);$.each(query,function(key,value){if(value==null||value=="")delete query[key]});return $.param(query)},JsonToQuery:function(data){return Convert.ToQuery(data)},
QueryToJson:function(query){var obj={};var re=/([^&=]+)=?([^&]*)/;try{var _queryArr=query.split(/&|\?/);$.each(_queryArr,function(index,_query){var _match=re.exec(_query);if(_match!=null)obj[_match[1]]=decodeURI(_match[2])})}catch(err){}return obj}};PATTERN={Int:"-?[0-9]+",UInt:"[0-9]+",Float:"-?[0-9]+(\\.[0-9]+)?",Zoom:"[0-9]+",Lat:"[\\+-]?[0-9]+(\\.[0-9]+)?",Lng:"[\\+-]?[0-9]+(\\.[0-9]+)?",Username:"[a-zA-Z0-9@\\*\\-\\._]+",Password:"^.{4,}$",Email:"\\S+@\\S+"};
$.fn.getInt=function(){if($(this).length>0)try{var val=parseInt($(this).val());if(isNaN(val))val=0;return val}catch(e){}return 0};$.fn.getIndex=function(){return $(this).parent().children().index($(this))};$.fn.getParentIndex=function(){var parentElem=$(this).parent();return $(parentElem).parent().children().index($(parentElem))};
$.fn.selectedValue=function(a){if(a==null)if($(this).filter(":checked").length==0)return null;else return $(this).filter(":checked").val();else{$(this).check(false).filter("[value='"+a+"']").check(true);return $(this)}};
$.fn.selectedValueMultiple=function(a){if(a==null){var result=[];$(this).filter(":checked").each(function(){result.push($(this).filter(":checked").val())});return result}else{$(this).check(false);if($.isArray(a))for(var i=0;i<a.length;i++)$(this).filter("[value='"+a[i]+"']").check(true);else $(this).filter("[value='"+a+"']").check(true);return $(this)}};$.fn.mustSelect=function(){if($(this).filter(":checked").length==0)$(this).first().check(true);return $(this)};
$.fn.disable=function(a){if(a==true||a==false){$(this).each(function(){$(this)[0].disabled=a});return $(this)}else return $(this)[0].disabled};$.fn.check=function(a){if(a==true||a==false){$(this).each(function(){$(this)[0].checked=a});return $(this)}else return $(this)[0].checked};
$.fn.checkValidity=function(){if($(this).length>=1)if($(this)[0].validity)return $(this)[0].validity;else{var validity={valueMissing:false,typeMismatch:false,patternMismatch:false,tooLong:false,rangeUnderflow:false,rangeOverflow:false,stepMismatch:false,badInput:false,customError:false,valid:true};if($(this).is("input:not(:radio):not(:checkbox), select, textarea")){var require=$(this).attr("required");if(typeof require=="undefined");else if(require==null||require==""||require=="required"||require.toLowerCase()==
"true")if($(this).val()==""){validity.valueMissing=true;validity.valid=false;return validity}if($(this).is("input[type=email]")){var re=new RegExp("^"+PATTERN.Email+"$");if(!re.test($(this).val())){validity.typeMismatch=true;validity.valid=false;return validity}}else if($(this).is("input[type=number]")){var re=new RegExp("^"+PATTERN.Float+"$");if(!re.test($(this).val())){validity.typeMismatch=true;validity.valid=false;return validity}}var pattern=$(this).attr("pattern");if(typeof pattern=="undefined");
else{var re=new RegExp("^"+pattern+"$");if(!re.test($(this).val())){validity.patternMismatch=true;validity.valid=false;return validity}}}if($(this).is("input:radio")){var require=$(this).attr("required");if(typeof require=="undefined");else if(require==null||require==""||require=="required"||require.toLowerCase()=="true"){var attrName=$(this).attr("name");if(attrName!=""&&attrName!=null)try{var $rads=$(this).parents("form").find("input:radio[name='"+attrName+"']");if($rads.length>0)if($rads.selectedValue()==
null){validity.valueMissing=true;validity.valid=false;return validity}}catch(err){}}}if($(this).is("input:checkbox")){var require=$(this).attr("required");if(typeof require=="undefined");else if(require==null||require==""||require=="required"||require.toLowerCase()=="true"){var attrName=$(this).attr("name");if(attrName!=""&&attrName!=null)try{var $rads=$(this).parents("form").find("input:checkbox[name='"+attrName+"']");if($rads.length>0)if($rads.selectedValue()==null){validity.valueMissing=true;validity.valid=
false;return validity}}catch(err){}}}return validity}return};$.fn.checkValidityAll=function(){var result=true;$(this).removeAttr("invalid").each(function(){try{if($(this).checkValidity().valid==false){$(this).attr("invalid","");result=false}}catch(err){}});return result};$.fn.delay=function(time,callback){jQuery.fx.step.delay=function(){};return this.animate({delay:1},time,callback)};$(function(){$(".btnTop").on("click",function(){$("html, body").animate({scrollTop:0},1E3)})});window.SystemModel=Backbone.Model.extend({defaults:{device:"unknown",version:null,isApp:false,isAppIOS:false,iOS:false,android:false,browser:null,offlineReady:false,lastOfflineUpdate:null},db:null,initialize:function(){var uaBrowser={"MSIE":/(msie)/i,"Firefox":/(firefox)/i,"Chrome":/((chrome)|(crios))/i,"Opera Mini":/(opera mini)/i,"Opera":/(opera)/i,"Safari":/(safari)/i,"WebKit":/(webkit)/i};var uaPlatform={"iOS":/((iphone)|(ipod)|(ipad))/i,"Android":/(android)/i,"Windows":/(windows)/i,"Mac":/(mac)/i};
var self=this;try{if(cordova){this.set("isApp",true);if(typeof navigator.device=="undefined")document.addEventListener("deviceready",_.bind(this.phonegapReady,this),false);else this.phonegapReady()}}catch(err){}var ua=navigator.userAgent;$.each(uaPlatform,function(platformname,re){try{if(re.test(ua)){self.set("device",platformname);return false}}catch(err){}});switch(this.get("device")){case "Android":this.set("android",true);break;case "iOS":this.set("iOS",true);break}$.each(uaBrowser,function(browsername,
re){try{if(re.test(ua)){self.set("browser",browsername);return false}}catch(err){}});if(this.get("android")&&this.get("browser")=="Safari")this.set("browser","Default");if(this.get("device")==this.defaults.device&&!this.isApp());},phonegapReady:function(){this.set("device",device.platform);if(this.isApp()&&$.inArray(device.platform,["iOS","iPad","iPhone","iPad Simulator","iPhone Simulator"])>-1)this.set("isAppIOS",true);this.loadOffline()},loadOffline:function(){var self=this;if(!self.isApp())return;
var db=window.openDatabase("yuewen","","YueWen",2*1E3*1E3);self.db=db;function errorCB(err){}function queryDBExist(tx,results){var dbOK=results.rows.length>0;window.readFile({folder:"data",filename:"allpassages.txt",success:function(data,file){loadData();if(dbOK){self.set({lastOfflineUpdate:file.lastModifiedDate,offlineReady:true});appRouter.reloadPage()}else self.loadPassagesIntoDB(data,errorCB,function(){self.set({lastOfflineUpdate:file.lastModifiedDate,offlineReady:true});appRouter.reloadPage()})},
error:function(){}})}function checkDBExist(tx,results){tx.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name='passage'",[],queryDBExist,errorCB)}db.transaction(checkDBExist,errorCB)},loadPassagesIntoDB:function(data,errorCB,successCB){if(data.success==true)if(data.passages.length>0){var passage=data.passages[0];var flds=_.keys(passage);var fldSql="";var qFlds=[];for(var i=0;i<flds.length;i++){qFlds.push("?");var fld=flds[i];if(fldSql!="")fldSql+=", ";switch(fld){case "id":fldSql+=
fld+" INTEGER PRIMARY KEY";break;case "publish":case "translated":fldSql+=fld+" INTEGER";break;case "createDate":case "lastUpdate":fldSql+=fld+" DATETIME";break;default:fldSql+=fld+" TEXT";break}}this.db.transaction(function(tx){tx.executeSql("DROP TABLE IF EXISTS passage");tx.executeSql("CREATE TABLE IF NOT EXISTS passage ("+fldSql+")");var qFldSql2=qFlds.join(",");var fldSql2=flds.join(",");for(var i=0;i<data.passages.length;i++)tx.executeSql("INSERT INTO passage ("+fldSql2+") VALUES ("+qFldSql2+
")",_.values(data.passages[i]))},errorCB,successCB)}},isApp:function(){return this.get("isApp")},isOfflineReady:function(){return this.get("offlineReady")},hasNetwork:function(){if(this.isApp()){var networkState=navigator.network.connection.type;return!(networkState==Connection.NONE)}return true},alert:function(msg){if(this.isApp())navigator.notification.alert(msg,function(){});else alert(msg)},confirm:function(msg){if(false&&this.isApp())return navigator.notification.confirm(msg,function(){});else return confirm(msg)},
quit:function(){if(this.isApp())if(device.platform=="iPhone")navigator.notification.alert('Press "Home" button to exit.',function(){},"Friendly Reminder");else if(device.platform=="Android")if(navigator.app.exitApp)navigator.app.exitApp();else navigator.notification.alert('Press "Home" button to exit.',function(){},"Friendly Reminder");else navigator.notification.alert('Press "Home" button to exit.',function(){},"Friendly Reminder")},hasQuitFunc:function(){if(this.isApp())if(navigator.app.exitApp)return true;
return false},canCaptureImage:function(){try{return window.File&&window.FileList&&window.FileReader}catch(e){return false}},canTouch:function(){try{document.createEvent("TouchEvent");return true}catch(e){return false}},canDrop:function(){try{document.createEvent("drop");return true}catch(e){return false}},canDragEnter:function(){try{document.createEvent("dragenter");return true}catch(e){return false}},notSupport:function(){if(this.isApp());else if($.browser.msie){if(parseInt($.browser.version,10)<=
8)return true}else if(this.get("browser")=="Opera Mini")return true;return false}});siteInfo=new SystemModel;appFunc=siteInfo;window.PageContentModel=Backbone.Model.extend({defaults:{success:null,error:null},isValid:function(){if(this.get("error")!=null)return false;if(this.get("success")==true)return true;return false}});window.PageModel=Backbone.Model.extend({defaults:{page:"",title:"",header:"",content:"",preload:false,ajax:""}});window.PageCollection=Backbone.Collection.extend({model:PageModel,where1:function(attributes){var result=this.where(attributes);return result.length==0?null:result[0]}});
window.PageInterface={modelEvents:null,collectionEvents:null,initializeBoundFunc:function(){_.bindAll(this)},removeBoundFunc:function(){},bindModelAndCollection:function(){if(this.model!=null&&!_.isEmpty(this.modelEvents))_.each(this.modelEvents,function(value,key){this.model.on(key,this[value],this)},this);if(this.collection!=null&&!_.isEmpty(this.collectionEvents))_.each(this.collectionEvents,function(value,key){this.collection.on(key,this[value],this)},this)},unbindModelAndCollection:function(){if(this.model!=
null&&!_.isEmpty(this.modelEvents))_.each(this.modelEvents,function(value,key){this.model.off(key,this[value],this)},this);if(this.collection!=null&&!_.isEmpty(this.collectionEvents))_.each(this.collectionEvents,function(value,key){this.collection.off(key,this[value],this)},this)},init:function(){},load:function(){},loadSubviews:function(){},unloadSubviews:function(){if(this.subviews!=null&&!_.isEmpty(this.subviews))_.each(this.subviews,function(value,key){if(value!=null)if(value instanceof Backbone.View){value.remove();
this.subviews[key]=null}},this)}};
window.PageView=Backbone.View.extend(_.extend({viewEl:"#content",el:"#content",initialize:function(){if(this.viewEl=="#content")appRouter._content=this;else if(this.viewEl=="#header")appRouter._header=this;this.subviews={};this.initializeBoundFunc();this.init();this.bindModelAndCollection();this.render();this.load();this.loadSubviews()},render:function(){return this.render2()},render2:function(obj,obj2){if($(this.el).length==0)this.$el.html($(this.viewEl,this.template(obj,obj2)).html());else $(this.el).html($(this.viewEl,
this.template(obj,obj2)).html());return this},render3:function(viewEl2,obj,obj2){$(viewEl2,this.el).html($(this.viewEl,this.template(obj,obj2)).find(viewEl2).html());return this},unrender:function(){},remove:function(){this.removeBoundFunc();this.unbindModelAndCollection();this.unloadSubviews();this.undelegateEvents();this.unrender();$(this.el).empty()}},window.PageInterface));
window.PageView_SubView=Backbone.View.extend(_.extend({viewEl:"#content",el:"#content",parentView:null,parent:null,initialRender:false,initialize:function(){this.subviews={};if(this.parentView)this.template=_.template(templateLoader.templates[this.parentView]);this.initializeBoundFunc();this.init();this.bindModelAndCollection();if(this.initialRender)this.render();this.load();this.loadSubviews()},render:function(){return this.render2()},render2:function(obj){var newEl=$(this.viewEl,this.template(obj));
$(this.el).html(newEl.html());$(this.el).attr("class",newEl.attr("class"));return this},render3:function(viewEl2,obj,obj2){$(viewEl2,this.el).html($(this.viewEl,this.template(obj,obj2)).find(viewEl2).html());return this},rerender:function(){this.remove();this.render();this.delegateEvents()},remove:function(){this._remove()},_remove:function(){this.removeBoundFunc();this.unbindModelAndCollection();this.unloadSubviews();this.undelegateEvents();$(this.el).empty()}},window.PageInterface));(function($){window.PassageSearchView=window.PageView.extend({init:function(){this.data=this.options.data;this.query=this.options.query},initializeBoundFunc:function(){_.bindAll(this,"updateLayout")},events:{"submit form":"search_submit"},loadSubviews:function(){},render:function(){return this.updateLayout()},updateLayout:function(){window.globalVar=this.data;var obj=this.render2(this.data);delete globalVar;return obj},search_submit:function(){var self=this;var postdata=$("form",this.el).serialize();
var query=$("form",this.el).attr("action");var url=rootURL+"/passage_search.php?"+query;$.ajax({type:"POST",url:url,data:postdata,success:function(data,textstatus,xhrreq){if(data.success==true){if(appRouter.content!=null)appRouter.content.remove();var query=xhrreq.getResponseHeader("X-MYAPP-Query");appRouter.content=new PassageView({param:null,data:data,query:query});var url=empty2(query)?"#page/passage":"#page/passage/"+query;appRouter.navigate(url,{trigger:true,replace:true});UpdateSocialToolbar()}},
dataType:"json",async:true});return false}})})(jQuery);(function($){window.PassageView=window.PageView.extend({init:function(){this.data=this.options.data;this.query=this.options.query},initializeBoundFunc:function(){_.bindAll(this,"updateLayout")},events:{"submit form":"search_submit","change .ddlPager":"changePage"},loadSubviews:function(){},render:function(){return this.updateLayout()},updateLayout:function(){try{if(this["myScroll"]!=null)this.myScroll.destroy()}catch(err){}try{$("#scroller",this.el).off()}catch(err){}if(this.data["offline"]==null)this.data.offline=
false;window.globalVar=this.data;var obj=this.render2(this.data);delete globalVar;var self=this;$("#scroller",this.el).css("width",166*$(".figurelist ul figure").length+"px").on("click","a",function(e){if($(this).parents("#scroller").is(".scrolling, .noclick"))return false;else $("#scroller").removeClass("noclick")});$("#scroller",this.el).on("touchstart mousedown","a",function(e){$("#scroller").removeClass("noclick");if($(this).parents("#scroller").is(".scrolling"))$("#scroller").addClass("noclick")});
this.myScroll=new iScroll("wrapper",{hScrollbar:true,bounce:false,onBeforeScrollMove:function(){$("#scroller").addClass("scrolling")},onScrollEnd:function(){$("#scroller").removeClass("scrolling")}});return obj},changePage:function(e){var currTarget=$(e.currentTarget);var href=$(currTarget).val();if(href!="")appRouter.navigate(href,{trigger:true,replace:true})},search_submit:function(){var self=this;if(appFunc.isApp()){window.globalVar=self.data;var url=query({search:$(".txtSearch",self.el).val()},
null,null);delete globalVar;appRouter.navigate(url,{trigger:true,replace:true})}else{var postdata=$("form",this.el).serialize();var queryString=$("form",this.el).attr("action");var url=rootURL+"/passage.php?"+queryString;$.ajax({type:"POST",url:url,data:postdata,success:function(data){if(data.success==true){window.globalVar=data;queryString=window.query();delete globalVar;self.data=data;self.query=queryString;self.updateLayout();appRouter.navigate(queryString,{trigger:false,replace:false});UpdateSocialToolbar()}},
dataType:"json",async:true})}return false}})})(jQuery);(function($){window.ReadingView=window.PageView.extend({init:function(){this.data=this.options.data;this.query=this.options.query},initializeBoundFunc:function(){_.bindAll(this,"updateLayout")},events:{"change #txtTags":"txtTags_change","click #divDirection button":"divDirection_click"},loadSubviews:function(){},render:function(){return this.updateLayout()},updateLayout:function(){window.globalVar=this.data;var obj=this.render2(this.data);delete globalVar;if(this.data.passage.tags!="")$("#txtTags",
this.el).change();this.changeDirection($("#btnHorizontal",this.el));if($.browser.mozilla)$("#btnVertical",this.el).addClass("disabled").disable(true);return obj},txtTags_change:function(e){var tags_str=$("#txtTags",this.el).val();var re=/[\s,\|\/]/g;var tags_arr=tags_str.split(/[\s,\|\/\n\r]/g);var tags_arr2=[];$("#divTags",this.el).empty();$.each(tags_arr,function(index,text){var text=String.trimChinese(text);if(text!=""){tags_arr2.push(text);$("#divTags",this.el).append($('<span class="label" />').text(text))}});
$("#txtTags",this.el).val(tags_arr2.join(" "))},divDirection_click:function(e){this.changeDirection($(e.currentTarget))},changeDirection:function($el){$("#divDirection button",this.el).removeClass("active");$($el).addClass("active");$("#divPassageOuter",this.el).toggleClass("vertical",$($el).val()=="vertical")}})})(jQuery);(function($){window.TranslationView=window.PageView.extend({init:function(){this.data=this.options.data;this.query=this.options.query},initializeBoundFunc:function(){_.bindAll(this,"updateLayout")},events:{"click .btnSubmit":"btnSubmit_click","click #divPassage span:not(.open) .sentence":"sentence_click","click #divPassage span.open:not(.correct) .phrases span.phrase":"phrase_click","click #divPassage span.open:not(.correct) .translation span.phrase":"phrase_click_reset","click #divPassage span.open:not(.correct) .phrases:empty":"phrasesHolder_click"},
loadSubviews:function(){},render:function(){return this.updateLayout()},updateLayout:function(){window.globalVar=this.data;var obj=this.render2(this.data);delete globalVar;$("#divPassage .sentence",this.el).first().addClass("blink");var lblSentence="子曰：";var lblPhrases="孔子➔說";$("#divPassage .phrases",this.el).each(function(index){var $divPhrases=$(this);var $divSentence=$divPhrases.siblings(".translation");var phtxt=$(this).text();if(phtxt!=""){var phrases=phtxt.split(/[|\/]/);var phrasesStr=phrases.join("");
$divPhrases.empty();$divSentence.data({"ans":phrasesStr});var phrases2=RANDOM.array(phrases,true);$.each(phrases2,function(index2,phrase){var $spanPhrase=$("<span class='phrase' />").text(phrase);if(index==0&&phrase==phrases[0])$spanPhrase.addClass("blink");$divPhrases.append($spanPhrase)})}});$("#divPassage .sentence.blink",this.el).tooltip({title:"➀ 按一下任何文言句子，開始重組語譯。",trigger:"manual",placement:"top",container:".divPassageOuter"});$("#divPassage .phrase.blink",this.el).tooltip({title:"➁ (順序)點選語譯詞組，把語譯重組到方格內。",
trigger:"manual",placement:"bottom",container:".divPassageOuter"});$("#btnSubmit",this.el).tooltip({title:"➂ 按一下「核對語譯」，檢查答案。",trigger:"manual",placement:"left"});$("#lblSentence,#lblSentence2",this.el).text(lblSentence);$("#lblPhrase,#lblPhrase2",this.el).text(lblPhrases);$(".divAlerts .alert-info",this.el).show();$("#divPassage .sentence.blink",this.el).tooltip("show");return obj},btnSubmit_click:function(){if($("#divPassage span.open",this.el).length==0)return;if($("#divPassage .phrase.blink",this.el).length>
0)return;$("#divPassage span.open.current",this.el).removeClass("current");$("#btnSubmit",this.el).tooltip("destroy");$("#divPassage span.open:not(.correct)",this.el).each(function(index){$span=$(this);var $divSentence=$span.find(".translation");var ans=$divSentence.data("ans");var optionTexts=[];$divSentence.find("span.phrase").each(function(){optionTexts.push($(this).text())});var studentans=optionTexts.join("");if(studentans==ans)$span.addClass("correct");else;});if($("#divPassage span.open:not(.correct)",
this.el).length>0){$(".divAlerts",this.el).find(".alert-warning, .alert-success").hide();$(".divAlerts",this.el).find(".alert-error").fadeIn();$("#divPassage span.open:not(.correct)",this.el).first().addClass("current")}else if($("#divPassage>div>span:not(.open)",this.el).length>0){$(".divAlerts",this.el).find(".alert-error, .alert-success").hide();$(".divAlerts",this.el).find(".alert-warning").fadeIn()}else{$(".divAlerts",this.el).find(".alert-error, .alert-warning, .alert-info").hide();$(".divAlerts",
this.el).find(".alert-success").fadeIn();$(".phrases, .btnSubmit",this.el).hide()}},sentence_click:function(e){var currTarget=$(e.currentTarget);$("#divPassage span.open.current",this.el).removeClass("current");$(currTarget).parents("span").first().addClass("open current");if($("#divPassage .sentence.blink",this.el).length>0)if($(currTarget).is(".blink")){$(currTarget).removeClass("blink").tooltip("destroy");$("#divPassage .phrase.blink",this.el).tooltip("show")}else{$("#divPassage .blink",this.el).removeClass("blink").tooltip("destroy");
$("#btnSubmit",this.el).tooltip("destroy")}},phrase_click:function(e){var currTarget=$(e.currentTarget);$("#divPassage span.open.current",this.el).removeClass("current");$(currTarget).parents("span.open").addClass("current");var $divPhrases=$(currTarget).parents(".phrases");var $divSentence=$divPhrases.siblings(".translation");$divSentence.append($(currTarget));if($("#divPassage .phrase.blink",this.el).length>0)if($(currTarget).is(".blink"))$(currTarget).removeClass("blink").tooltip("destroy");else{$("#divPassage .blink",
this.el).removeClass("blink").tooltip("destroy");$("#btnSubmit",this.el).tooltip("destroy")}if($divPhrases.is(":empty"))$("#btnSubmit",this.el).tooltip("show")},phrase_click_reset:function(e){var currTarget=$(e.currentTarget);$("#divPassage span.open.current",this.el).removeClass("current");$(currTarget).parents("span.open").addClass("current");var $divSentence=$(currTarget).parents(".translation");var $divPhrases=$divSentence.siblings(".phrases");$divPhrases.append($(currTarget))},phrasesHolder_click:function(e){var currTarget=
$(e.currentTarget);$("#divPassage span.open.current",this.el).removeClass("current");$(currTarget).parents("span.open").addClass("current");var $divPhrases=$(currTarget);var $divSentence=$divPhrases.siblings(".translation");$divPhrases.append($divSentence.find("span.phrase"))}})})(jQuery);(function($){window.NetworkErrorView=window.PageView.extend({})})(jQuery);(function($){window.NotSupportView=window.PageView.extend({render:function(){var obj=this.render2();$("#footer").hide();return obj}})})(jQuery);(function($){window.ErrorView=window.PageView.extend({})})(jQuery);(function($){window.NotFoundView=window.PageView.extend({})})(jQuery);(function($){window.AboutView=window.PageView.extend({})})(jQuery);(function($){window.HomeView=window.PageView.extend({events:{"click .btnDownload":"downloadPassages"},loadSubviews:function(){},downloadPassages:function(){$(".divDownload .btnDownload").attr("disabled","");if(!appFunc.isApp()){$(".divDownload .btnDownload").removeAttr("disabled");return}try{var networkState=navigator.network.connection.type;if(networkState==Connection.NONE){appFunc.alert("沒有網路連線。\n請確定流動裝置成功連上網路(如：3g、4g或WiFi)後再次嘗試。");$(".divDownload .btnDownload").removeAttr("disabled");return}}catch(err){}if(!appFunc.confirm("開始下載篇章？")){$(".divDownload .btnDownload").removeAttr("disabled");
return}downloadPassagesOffline()}})})(jQuery);(function($){window.TmplHeaderView=window.PageView.extend({LoadSocialToolbar:function(){if(siteInfo.isApp())return;var script="http://s7.addthis.com/js/300/addthis_widget.js#domready=1";if(window["addthis"]!=null){window.addthis=null;window._adr=null;window._atc=null;window._atd=null;window._ate=null;window._atr=null;window._atw=null}$.getScript(script,function(){addthis.init()})}});window.HeaderView=window.TmplHeaderView.extend({viewEl:"#header",el:$("#header"),events:{"submit form":"search_submit"},
load:function(){this.LoadSocialToolbar()},search_submit:function(){var query={"search":$("input[name=txtSearch]",this.el).val()};var url="#page/passage/"+Convert.ToQuery(query);appRouter.navigate(url,{trigger:true,replace:true});$("input[name=txtSearch]",this.el).val("");return false}});window.NoHeaderView=window.TmplHeaderView.extend({viewEl:"#header",el:$("#header"),load:function(){this.LoadSocialToolbar()}})})(jQuery);var FIELDS=FIELDS||{};$(function(){if(isDemo)$("#page").addClass("demo")});var addthis_config={ui_language:"zh-tw",data_track_clickback:false,data_track_addressbar:false};var addthis_share={url:baseURL,title:"悦文 - 文選．語譯"};var addthis_localize={share_caption:"分享",email_caption:"電郵",more:"更多"};
function UpdateSocialToolbar(){if(siteInfo.isApp())return;var newURL=document.URL;addthis_share.url=newURL;if(window["addthis"]!=null){addthis.update("share","url",newURL);addthis.url=newURL;addthis.toolbox(".addthis_toolbox")}}
var AppRouter=Backbone.Router.extend({routes:{"page/:page/:query":"showPage","page/:page/":"showPage","page/:page":"showPage","":"showHome","*path":"showNotFound"},initialize:function(options){var self=this;this.pages=new PageCollection([{page:"home",title:"Home",header:"HeaderView",content:"HomeView"},{page:"about",title:"About",header:"HeaderView",content:"AboutView"},{page:"networkerror",title:"Network Error",header:"HeaderView",content:"NetworkErrorView"},{page:"404",title:"404 Not Found",header:"HeaderView",
content:"NotFoundView"},{page:"error",title:"Error",header:"HeaderView",content:"ErrorView"},{page:"notsupport",title:"Not support",header:"HeaderView",content:"NotSupportView"},{page:"passage",title:"Passage List",header:"HeaderView",content:"PassageView",preload:true},{page:"passage_search",title:"Passage Search",header:"HeaderView",content:"PassageSearchView",preload:true},{page:"reading",title:"Reading",header:"HeaderView",content:"ReadingView",preload:true},{page:"translation",title:"Translation",
header:"HeaderView",content:"TranslationView",preload:true,ajax:"reading"}])},showPage:function(page,query){if(page!="notsupport"&&siteInfo.notSupport()){this.showNotSupport();return}var page_out=this.pages.where1({"page":page});if(page_out==null){this.showNotFound();return}var headerView=window[page_out.get("header")];var contentView=window[page_out.get("content")];if(headerView===undefined){this.showError();return}if(contentView===undefined){this.showError();return}if(!(this.header&&this.header instanceof
headerView)){if(this.header!=null)this.header.remove();this.header=new headerView}if(page_out.get("preload")==true){var replaceContent=false;if(!(this.content&&this.content instanceof contentView))replaceContent=true;var self=this;var pageAjax=!empty2(page_out.get("ajax"))?page_out.get("ajax"):page_out.get("page");query=encodeURI(query);if(appFunc.isApp()){if(appFunc.isOfflineReady())try{function successCB(data){if(replaceContent){if(self.content!=null)self.content.remove();self.content=new contentView({param:null,
data:data,query:query})}else{self.content.data=data;self.content.query=query;self.content.render()}UpdateSocialToolbar();self.trackPageView()}if(pageAjax=="reading"){var queryArr=Convert.QueryToJson("?"+query);if(queryArr["id"])LoadFromOffline({table:"passage",id:queryArr["id"],success:successCB})}if(pageAjax=="passage"){var queryArr=Convert.QueryToJson("?"+query);LoadFromOffline({table:"passage",queryData:queryArr,success:successCB,error:function(){}})}}catch(err){}}else $.ajax({url:rootURL+"/"+
pageAjax+".php?"+(query!=null?query:""),success:function(data,textStatus,xhr){if(data.success==true){if(replaceContent){if(self.content!=null)self.content.remove();self.content=new contentView({param:null,data:data,query:query})}else{self.content.data=data;self.content.query=query;self.content.render()}UpdateSocialToolbar();self.trackPageView()}},error:function(){self.showPage("networkerror")},contentType:"application/json; charset=utf-8",dataType:"json",processData:true,type:"GET"})}else if(!(this.content&&
this.content instanceof contentView)){if(this.content!=null)this.content.remove();this.content=new contentView;UpdateSocialToolbar();this.trackPageView()}this._header=this._content=null},showHome:function(){appRouter.navigate("#page/home",{trigger:true,replace:true})},showNotFound:function(){this.showPage("404")},showError:function(){this.showPage("error")},showNotSupport:function(){this.showPage("notsupport")},reloadPage:function(){var href=location.hash;if(this.header!=null){this.header.remove();
this.header=null}if(this.content!=null){this.content.remove();this.content=null}Backbone.history.loadUrl(href)},loadPage:function(url){if(this.header!=null){this.header.remove();this.header=null}if(this.content!=null){this.content.remove();this.content=null}if(url!=null){var href=url;Backbone.history.loadUrl(href)}},trackPageView:function(){try{var hash=location.hash;if(hash)_gaq.push(["_trackPageview",hash.substr(1)]);else _gaq.push(["_trackPageview"])}catch(err){}}});
templateLoader.load(["HeaderView","NoHeaderView","HomeView","AboutView","NotFoundView","ErrorView","NotSupportView","NetworkErrorView","PassageView","PassageSearchView","ReadingView","TranslationView"],function(){appRouter=new AppRouter;if(siteInfo.isApp())Backbone.history.start();else if(isLocal&&testPushState)Backbone.history.start({pushState:isDemo||isLocal,root:baseURL_root+"/"});else if(isDemo&&testPushState)Backbone.history.start({pushState:isDemo||isLocal,root:baseURL_root+"/"});else Backbone.history.start({pushState:testPushState,
root:baseURL_root+"/"});if(Backbone.history&&Backbone.history._hasPushState)$(document).delegate("a:not([data-bypass]):not([data-toggle])","click",function(evt){var href=$(this).attr("href");if(href.indexOf("javascript:")>=0)return;if(href.indexOf("http://")>=0)return;if(href.indexOf("https://")>=0)return;if($(this).parents("#socialToolbar").length>0)return;var protocol=this.protocol+"//";if(href.slice(protocol.length)!==protocol){evt.preventDefault();Backbone.history.navigate(href,true)}});else if(siteInfo.isApp())$(document).delegate("a:not([data-bypass]):not([data-toggle])",
"click",function(evt){var href=$(this).attr("href");if(href.indexOf("javascript:")>=0)return;if(href.indexOf("http://")>=0){window.open(href,"_system");return false}if(href.indexOf("https://")>=0){window.open(href,"_system");return false}})});if(!siteInfo.isApp())$.ajax({url:rootURL+"/data.php",success:function(data,textStatus,xhr){if(data.success==true)FIELDS=data.fields},error:function(){},dataType:"json",async:false,cache:false});
